PHASE VI: PL/SQL Development

1Ô∏è‚É£ FUNCTION: Get Active Point Rule

This function finds the currently active rule.

CREATE OR REPLACE FUNCTION fn_get_active_rule
RETURN point_rules%ROWTYPE
IS
    v_rule point_rules%ROWTYPE;
BEGIN
    SELECT *
    INTO v_rule
    FROM point_rules
    WHERE effective_date <= SYSDATE
      AND (expiry_date IS NULL OR expiry_date >= SYSDATE)
    FETCH FIRST 1 ROW ONLY;

    RETURN v_rule;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20001, 'No active point rule found');
END;
/

2Ô∏è‚É£ FUNCTION: Calculate Earned Points
CREATE OR REPLACE FUNCTION fn_calculate_points (
    p_amount NUMBER
) RETURN NUMBER
IS
    v_rule point_rules%ROWTYPE;
    v_points NUMBER;
BEGIN
    v_rule := fn_get_active_rule;

    v_points := FLOOR(p_amount / v_rule.amount_threshold)
                * v_rule.points_per_unit;

    RETURN v_points;
END;
/

3Ô∏è‚É£ FUNCTION: Get Customer Total Points
CREATE OR REPLACE FUNCTION fn_get_total_points (
    p_customer_id NUMBER
) RETURN NUMBER
IS
    v_total NUMBER;
BEGIN
    SELECT NVL(SUM(points_earned - points_redeemed), 0)
    INTO v_total
    FROM rewards
    WHERE customer_id = p_customer_id;

    RETURN v_total;
END;
/

4Ô∏è‚É£ PROCEDURE: Record a Purchase (CORE PROCEDURE)

This procedure:

Inserts a purchase

Calculates points

Inserts into rewards

CREATE OR REPLACE PROCEDURE pr_record_purchase (
    p_customer_id     NUMBER,
    p_amount          NUMBER,
    p_payment_method  VARCHAR2,
    p_description     VARCHAR2
)
IS
    v_purchase_id NUMBER;
    v_points      NUMBER;
BEGIN
    -- Insert purchase
    v_purchase_id := seq_purchase_id.NEXTVAL;

    INSERT INTO purchases (
        purchase_id, customer_id, total_amount,
        payment_method, description
    )
    VALUES (
        v_purchase_id, p_customer_id, p_amount,
        p_payment_method, p_description
    );

    -- Calculate points
    v_points := fn_calculate_points(p_amount);

    -- Insert reward
    INSERT INTO rewards (
        reward_id, customer_id, purchase_id,
        points_earned, transaction_type
    )
    VALUES (
        seq_reward_id.NEXTVAL,
        p_customer_id,
        v_purchase_id,
        v_points,
        'EARN'
    );

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

5Ô∏è‚É£ PROCEDURE: Redeem Points
CREATE OR REPLACE PROCEDURE pr_redeem_points (
    p_customer_id NUMBER,
    p_points      NUMBER
)
IS
    v_available NUMBER;
BEGIN
    v_available := fn_get_total_points(p_customer_id);

    IF p_points > v_available THEN
        RAISE_APPLICATION_ERROR(-20002, 'Insufficient loyalty points');
    END IF;

    INSERT INTO rewards (
        reward_id, customer_id,
        points_redeemed, transaction_type
    )
    VALUES (
        seq_reward_id.NEXTVAL,
        p_customer_id,
        p_points,
        'REDEEM'
    );

    COMMIT;
END;
/

6Ô∏è‚É£ PROCEDURE WITH CURSOR:

CREATE OR REPLACE PROCEDURE pr_upgrade_membership
IS
    CURSOR c_customers IS
        SELECT customer_id
        FROM customers;

    v_points NUMBER;
BEGIN
    FOR rec IN c_customers LOOP
        v_points := fn_get_total_points(rec.customer_id);

        UPDATE customers
        SET membership_tier =
            CASE
                WHEN v_points >= 10000 THEN 'PLATINUM'
                WHEN v_points >= 5000  THEN 'GOLD'
                WHEN v_points >= 1000  THEN 'SILVER'
                ELSE 'BRONZE'
            END
        WHERE customer_id = rec.customer_id;
    END LOOP;

    COMMIT;
END;
/

7Ô∏è‚É£ PACKAGE

üîπ Package Specification

CREATE OR REPLACE PACKAGE pkg_loyalty IS
    PROCEDURE record_purchase(
        p_customer_id NUMBER,
        p_amount NUMBER,
        p_payment_method VARCHAR2,
        p_description VARCHAR2
    );

    PROCEDURE redeem_points(
        p_customer_id NUMBER,
        p_points NUMBER
    );

    FUNCTION total_points(
        p_customer_id NUMBER
    ) RETURN NUMBER;
END pkg_loyalty;
/

üîπ Package Body
CREATE OR REPLACE PACKAGE BODY pkg_loyalty IS

    PROCEDURE record_purchase(
        p_customer_id NUMBER,
        p_amount NUMBER,
        p_payment_method VARCHAR2,
        p_description VARCHAR2
    ) IS
    BEGIN
        pr_record_purchase(
            p_customer_id,
            p_amount,
            p_payment_method,
            p_description
        );
    END;

    PROCEDURE redeem_points(
        p_customer_id NUMBER,
        p_points NUMBER
    ) IS
    BEGIN
        pr_redeem_points(p_customer_id, p_points);
    END;

    FUNCTION total_points(
        p_customer_id NUMBER
    ) RETURN NUMBER IS
    BEGIN
        RETURN fn_get_total_points(p_customer_id);
    END;

END pkg_loyalty;
/

8Ô∏è‚É£ TESTING 
-- Record purchase
BEGIN
    pkg_loyalty.record_purchase(
        10001,
        25000,
        'MOMO',
        'Supermarket items'
    );
END;
/

-- Redeem points
BEGIN
    pkg_loyalty.redeem_points(10001, 100);
END;
/

-- Check points
SELECT pkg_loyalty.total_points(10001) AS total_points FROM dual;

